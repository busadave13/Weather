name: Publish Docker Image and Helm Charts

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Create prerelease version"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  GITHUB_USERNAME: busadave13
  IMAGE_NAME: weather
  HELM_REPOSITORY: helm/weather
  HELM_CHART_PATH: charts/weather

jobs:
  publish:
    # Only run if PR was merged (not just closed) or manually dispatched
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for semantic versioning

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore src/Weather/Weather.csproj

      - name: Build
        run: dotnet build src/Weather/Weather.csproj -c Release --no-restore

      - name: Run tests
        run: dotnet test src/Weather.Test/Weather.Test.csproj -c Release --verbosity normal

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: "5.x"

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.10.2
        with:
          useConfigFile: true
          configFilePath: .gitversion.yml

      - name: Calculate semantic version
        id: version
        run: |
          # Get the base semantic version (clean version without pre-release tags)
          BASE_VERSION="${{ steps.gitversion.outputs.majorMinorPatch }}"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger
            if [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
              if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
                # Private branch prerelease
                BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
                CHART_VERSION="${BASE_VERSION}-${BRANCH_NAME}.${{ github.run_number }}"
                IMAGE_VERSION="${BASE_VERSION}-${BRANCH_NAME}.${{ github.run_number }}"
              else
                CHART_VERSION="${BASE_VERSION}-rc.${{ github.run_number }}"
                IMAGE_VERSION="${BASE_VERSION}-rc.${{ github.run_number }}"
              fi
            else
              # Manual release - use clean version
              CHART_VERSION="${BASE_VERSION}"
              IMAGE_VERSION="${BASE_VERSION}"
            fi
          else
            # PR merged - use clean semantic version
            CHART_VERSION="${BASE_VERSION}"
            IMAGE_VERSION="${BASE_VERSION}"
          fi

          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "image_version=$IMAGE_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated chart version: $CHART_VERSION"
          echo "Calculated image version: $IMAGE_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_version }}
            ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Update Helm chart versions
        run: |
          # Update Chart.yaml with new chart version
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.chart_version }}/" ${{ env.HELM_CHART_PATH }}/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.image_version }}\"/" ${{ env.HELM_CHART_PATH }}/Chart.yaml

          # Update values.yaml with new image tag (but don't commit this change)
          sed -i "s|name: .*weather:.*|name: ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_version }}|" ${{ env.HELM_CHART_PATH }}/values.yaml

          echo "Updated Chart.yaml and values.yaml:"
          echo "--- Chart.yaml version info ---"
          grep -E "^(version|appVersion):" ${{ env.HELM_CHART_PATH }}/Chart.yaml
          echo "--- values.yaml image info ---"
          grep "name: .*weather:" ${{ env.HELM_CHART_PATH }}/values.yaml

      - name: Package Helm chart
        run: |
          helm package ${{ env.HELM_CHART_PATH }} -d ./helm-packages

      - name: Log in to GitHub Container Registry (OCI registry for Helm)
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Push Helm chart to GitHub Container Registry (OCI)
        run: |
          CHART_VERSION=${{ steps.version.outputs.chart_version }}
          
          # Debug: List all files in helm-packages directory
          echo "Files in helm-packages directory:"
          ls -la ./helm-packages/
          
          # Find the actual chart package file (should match the chart version)
          CHART_PACKAGE=$(find ./helm-packages -name "${{ env.IMAGE_NAME }}-*.tgz" | head -1)
          
          if [ -z "$CHART_PACKAGE" ]; then
            echo "Error: No chart package found!"
            exit 1
          fi
          
          echo "Found chart package: $CHART_PACKAGE"
          helm push $CHART_PACKAGE oci://${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/helm

      - name: Commit version changes (Chart.yaml only)
        if: github.event.pull_request.merged == true # Only commit on PR merge, not manual runs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Reset values.yaml to original state (don't commit image version change)
          git checkout HEAD -- ${{ env.HELM_CHART_PATH }}/values.yaml

          # Only commit Chart.yaml changes
          git add ${{ env.HELM_CHART_PATH }}/Chart.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bump chart version to ${{ steps.version.outputs.chart_version }}"
            git push origin HEAD:main
          fi

      - name: Create GitHub Release
        if: github.event.pull_request.merged == true # Only create release on PR merge
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.base_version }}
          release_name: Release v${{ steps.version.outputs.base_version }}
          body: |
            ## Docker Image
            - `docker pull ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_version }}`
            - `docker pull ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest`

            ## Helm Chart
            ```bash
            helm install weather oci://${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/helm/weather --version ${{ steps.version.outputs.chart_version }}
            ```

            ## Changes
            ${{ github.event.pull_request.title || 'Manual release' }}

            ### Version Details
            - Chart Version: ${{ steps.version.outputs.chart_version }}
            - Image Version: ${{ steps.version.outputs.image_version }}
            - Git SHA: ${{ github.sha }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' || contains(steps.version.outputs.chart_version, '-') }}
        continue-on-error: true # Don't fail if tag already exists

      - name: Summary
        run: |
          echo "## ðŸš€ Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart Version**: \`${{ steps.version.outputs.chart_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Version**: \`${{ steps.version.outputs.image_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Version**: \`${{ steps.version.outputs.base_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Chart" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm install weather oci://${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/helm/weather --version ${{ steps.version.outputs.chart_version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "### ðŸ§ª Test Release" >> $GITHUB_STEP_SUMMARY
            echo "This is a test release from branch \`${{ github.ref_name }}\`. The image version in values.yaml was updated temporarily but not committed." >> $GITHUB_STEP_SUMMARY
          fi
